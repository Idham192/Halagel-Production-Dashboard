<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MFG Dashboard V5</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            indigo: { 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
            slate: { 850: '#151e2e', 900: '#0f172a' },
            emerald: { 50: '#ecfdf5', 600: '#059669' },
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    body { transition: background-color 0.3s, color 0.3s; }
    .glass-panel { 
        background: white; 
        backdrop-filter: blur(12px); 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .dark .glass-panel { 
        background: rgba(30, 41, 59, 0.9); 
        border: 1px solid rgba(255, 255, 255, 0.05); 
    }
    /* Month Header */
    .month-header {
        position: relative;
        text-align: center;
        margin: 1.5rem 0 1rem 0;
    }
    .month-header span {
        background: #e2e8f0;
        padding: 0.3rem 1rem;
        border-radius: 9999px;
        font-weight: 800;
        font-size: 0.8rem;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: relative;
        z-index: 10;
    }
    .dark .month-header span {
        background: #334155;
        color: #e2e8f0;
    }
    .month-header::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 1px;
        background: #cbd5e1;
        z-index: 0;
    }
    .dark .month-header::before {
        background: #334155;
    }

    /* Off Day Styling */
    .off-day-header {
        background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%) !important;
        color: white;
    }
    .off-day-body {
        background-color: #fef2f2;
    }
    .dark .off-day-body {
        background-color: #450a0a;
        opacity: 0.3;
    }
  </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 font-sans antialiased">

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="hidden md:flex flex-col w-64 bg-white dark:bg-slate-850 border-r border-gray-200 dark:border-slate-700 z-30 shadow-md">
      <div class="p-6 flex items-center gap-3 border-b border-gray-100 dark:border-slate-800">
        <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg">
          <i class="fas fa-industry text-lg"></i>
        </div>
        <div>
          <h1 class="font-extrabold text-xl tracking-tight">MFG<span class="text-indigo-600">HUB</span></h1>
          <p class="text-[10px] font-bold text-slate-400 uppercase">Production V5</p>
        </div>
      </div>
      
      <nav class="flex-1 px-4 space-y-1 mt-4">
        <button onclick="loadCategory('Healthcare')" id="nav-Healthcare" class="nav-btn group flex items-center w-full gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-indigo-50 dark:hover:bg-slate-800 transition">
          <i class="fas fa-medkit w-5"></i> Healthcare
        </button>
        <button onclick="loadCategory('Toothpaste')" id="nav-Toothpaste" class="nav-btn group flex items-center w-full gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-indigo-50 dark:hover:bg-slate-800 transition">
          <i class="fas fa-tooth w-5"></i> Toothpaste
        </button>
        <button onclick="loadCategory('Rocksalt')" id="nav-Rocksalt" class="nav-btn group flex items-center w-full gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-indigo-50 dark:hover:bg-slate-800 transition">
          <i class="fas fa-cube w-5"></i> Rocksalt
        </button>
        
        <!-- Last Updated Info -->
        <div class="mt-4 px-4 py-3 bg-gray-50 dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Last Update</p>
            <div class="flex items-center gap-2 mb-1">
                <i class="fas fa-user-circle text-indigo-500 text-xs"></i>
                <p id="lastUpdateUser" class="text-xs font-bold truncate">-</p>
            </div>
            <div class="flex items-center gap-2">
                <i class="fas fa-clock text-gray-400 text-xs"></i>
                <p id="lastUpdateTime" class="text-[10px] text-gray-500 font-mono">-</p>
            </div>
        </div>

        <!-- Manager & Admin Settings -->
        <div id="managerControls" class="hidden mt-4 pt-4 border-t border-gray-200 dark:border-slate-700">
          <p class="px-4 text-xs font-bold text-gray-400 uppercase mb-2">Manager</p>
          <button onclick="openOffDayModal()" class="group flex items-center w-full gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-red-50 dark:hover:bg-slate-800 transition text-red-600">
            <i class="fas fa-calendar-times w-5"></i> Set Off Days
          </button>
        </div>

        <div id="adminControls" class="hidden mt-2">
           <p class="px-4 text-xs font-bold text-gray-400 uppercase mb-2">Admin</p>
           <button onclick="openUserModal()" class="group flex items-center w-full gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-purple-50 dark:hover:bg-slate-800 transition text-purple-600">
            <i class="fas fa-users-cog w-5"></i> Manage Users
          </button>
        </div>
      </nav>

      <!-- User Profile -->
      <div class="p-4 border-t border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900/50">
        <div id="userProfileSection" class="flex items-center gap-3 justify-between">
           <button onclick="openLoginModal()" class="w-full px-3 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30">Login System</button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
      <!-- Header -->
      <header class="h-16 bg-white dark:bg-slate-850 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between px-6 z-20">
        <div class="flex items-center gap-4">
            <h2 id="pageTitle" class="text-xl font-extrabold text-gray-800 dark:text-white">Dashboard</h2>
        </div>
        <div class="flex items-center gap-3">
            <button id="inputDataBtn" onclick="openInputModal()" class="hidden px-4 py-2 bg-emerald-600 text-white text-sm font-bold rounded-lg hover:bg-emerald-700 transition flex items-center gap-2">
                <i class="fas fa-plus"></i> Input Data
            </button>
            <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center">
              <i class="fas fa-moon dark:hidden text-gray-600"></i>
              <i class="fas fa-sun hidden dark:block text-yellow-500"></i>
            </button>
        </div>
      </header>

      <!-- Dashboard Content -->
      <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-panel p-6 rounded-2xl border-l-4 border-blue-500 flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-slate-500">Total Plan Quantity</p>
                    <h3 id="kpiTarget" class="text-3xl font-extrabold mt-1 text-blue-600 dark:text-blue-400">0</h3>
                </div>
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/50 rounded-full flex items-center justify-center text-blue-600">
                    <i class="fas fa-clipboard-list text-xl"></i>
                </div>
            </div>
            <div class="glass-panel p-6 rounded-2xl border-l-4 border-green-500 flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-slate-500">Total Actual Quantity</p>
                    <h3 id="kpiActual" class="text-3xl font-extrabold mt-1 text-green-600 dark:text-green-400">0</h3>
                </div>
                <div class="w-12 h-12 bg-green-100 dark:bg-green-900/50 rounded-full flex items-center justify-center text-green-600">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="glass-panel rounded-2xl p-5">
            <h3 class="font-bold text-lg mb-4">Weekly Production</h3>
            <div class="h-64"><canvas id="weeklyChart"></canvas></div>
        </div>

        <!-- Production Log -->
        <div class="glass-panel rounded-2xl overflow-hidden flex flex-col min-h-[400px]">
            <div class="p-5 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-table mr-2"></i>Production Log</h3>
                <button onclick="fetchData()" class="text-sm text-indigo-600 font-semibold hover:underline"><i class="fas fa-sync-alt mr-1"></i> Refresh</button>
            </div>
            <div id="loader" class="hidden flex justify-center items-center h-48"><i class="fas fa-circle-notch fa-spin text-3xl text-indigo-500"></i></div>
            <div id="tableContainer" class="p-4 space-y-4"></div>
            <div id="emptyState" class="hidden flex justify-center items-center h-48 text-slate-400">No data found.</div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL: Login -->
  <div id="loginModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-96 shadow-2xl relative">
      <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      <h3 class="text-2xl font-bold text-center mb-6">Login</h3>
      <input type="text" id="username" class="w-full p-3 mb-4 rounded bg-gray-50 dark:bg-slate-900 border dark:border-slate-700" placeholder="Username">
      <input type="password" id="password" class="w-full p-3 mb-6 rounded bg-gray-50 dark:bg-slate-900 border dark:border-slate-700" placeholder="Password">
      <button onclick="performLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Log In</button>
    </div>
  </div>

  <!-- MODAL: User Management (Admin Only) -->
  <div id="userModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-[500px] shadow-2xl max-h-[80vh] flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-purple-600">User Management</h3>
        <button onclick="closeUserModal()" class="text-gray-500"><i class="fas fa-times"></i></button>
      </div>
      
      <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg mb-4">
          <h4 class="text-sm font-bold mb-2">Add New User</h4>
          <div class="grid grid-cols-3 gap-2 mb-2">
              <input type="text" id="newUsername" placeholder="Username" class="p-2 text-sm border rounded dark:bg-slate-900 dark:border-slate-700">
              <input type="password" id="newPassword" placeholder="Password" class="p-2 text-sm border rounded dark:bg-slate-900 dark:border-slate-700">
              <select id="newRole" class="p-2 text-sm border rounded dark:bg-slate-900 dark:border-slate-700">
                  <option value="Operator">Operator</option>
                  <option value="Planner">Planner</option>
                  <option value="Manager">Manager</option>
                  <option value="Admin">Admin</option>
              </select>
          </div>
          <button onclick="addNewUser()" class="w-full bg-purple-600 text-white py-2 rounded text-sm font-bold hover:bg-purple-700">Add User</button>
      </div>

      <div class="flex-1 overflow-y-auto">
          <table class="w-full text-sm text-left">
              <thead class="bg-gray-100 dark:bg-slate-700 font-bold">
                  <tr>
                      <th class="p-2">Username</th>
                      <th class="p-2">Role</th>
                      <th class="p-2 text-center">Action</th>
                  </tr>
              </thead>
              <tbody id="userListBody" class="divide-y divide-gray-200 dark:divide-slate-700"></tbody>
          </table>
      </div>
    </div>
  </div>

  <!-- MODAL: Input Data -->
  <div id="inputModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-0 w-[500px] shadow-2xl overflow-hidden">
      <!-- Tabs -->
      <div class="flex border-b border-gray-200 dark:border-slate-700">
          <button onclick="switchInputTab('Plan')" id="tabPlan" class="flex-1 py-4 font-bold text-center bg-indigo-50 text-indigo-700 transition">Input Plan</button>
          <button onclick="switchInputTab('Actual')" id="tabActual" class="flex-1 py-4 font-bold text-center text-gray-500 hover:bg-gray-50 transition">Input Actual</button>
      </div>
      
      <div class="p-6 relative">
          <button onclick="closeInputModal()" class="absolute top-2 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
          <form id="inputForm" class="space-y-4">
              <input type="hidden" id="inputType" value="Plan">
              
              <div>
                  <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Date</label>
                  <input type="date" id="inputDate" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700">
              </div>

              <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Category</label>
                    <select id="inputCategory" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700">
                        <option value="Healthcare">Healthcare</option>
                        <option value="Toothpaste">Toothpaste</option>
                        <option value="Rocksalt">Rocksalt</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Process</label>
                    <select id="inputProcess" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700">
                        <option value="Mixing">Mixing</option>
                        <option value="Filling">Filling</option>
                        <option value="Encapsulation">Encapsulation</option>
                        <option value="Packing">Packing</option>
                        <option value="Sorting">Sorting</option>
                    </select>
                  </div>
              </div>

              <div>
                  <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Product Name</label>
                  <input type="text" id="inputProduct" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700" placeholder="Product Name">
              </div>

              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Quantity</label>
                      <input type="number" id="inputQty" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700" placeholder="0">
                  </div>
                  <div id="manpowerFieldContainer">
                      <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Manpower</label>
                      <input type="number" id="inputManpower" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700" value="5">
                  </div>
              </div>

              <div id="actualFields" class="hidden">
                  <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Batch No</label>
                  <input type="text" id="inputBatch" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700" placeholder="Batch No">
              </div>

              <button type="button" onclick="submitData()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 mt-4">
                  <i class="fas fa-paper-plane mr-2"></i> Submit Data
              </button>
          </form>
      </div>
    </div>
  </div>

  <!-- MODAL: Off Day Calendar -->
  <div id="offDayModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-96 shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Set Off Days</h3>
        <button onclick="closeOffDayModal()" class="text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
      </div>
      
      <div class="space-y-4">
        <div class="flex gap-2">
            <input type="date" id="offDayPicker" class="flex-1 p-2 rounded border dark:bg-slate-900 dark:border-slate-700">
            <button onclick="addOffDay()" class="px-4 bg-indigo-600 text-white rounded font-bold">Add</button>
        </div>
        
        <div class="h-40 overflow-y-auto border rounded p-2 dark:border-slate-700 bg-gray-50 dark:bg-slate-900">
            <ul id="offDayList" class="space-y-2 text-sm"></ul>
        </div>
        
        <button onclick="saveOffDays()" class="w-full bg-emerald-600 text-white py-2 rounded font-bold hover:bg-emerald-700">Okay (Save)</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Edit Data -->
  <div id="editModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-[450px] shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-indigo-600">Edit Data</h3>
        <button onclick="closeEditModal()" class="text-gray-500"><i class="fas fa-times"></i></button>
      </div>
      <div class="space-y-3">
          <input type="hidden" id="editPlanId"> 
          <input type="hidden" id="editActualId"> 
          
          <div><label class="text-xs font-bold text-gray-500">Date</label>
          <input type="text" id="editDateDisplay" disabled class="w-full p-2 bg-gray-100 dark:bg-slate-700 rounded text-gray-500"></div>
          
          <div><label class="text-xs font-bold text-gray-500">Product</label>
          <input type="text" id="editProduct" disabled class="w-full p-2 bg-gray-100 dark:bg-slate-700 rounded text-gray-500"></div>

          <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-blue-600">Plan Qty</label>
                <input type="number" id="editPlanQty" class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-700">
              </div>
              <div>
                <label class="text-xs font-bold text-green-600">Actual Qty</label>
                <input type="number" id="editActualQty" class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-700">
              </div>
          </div>
          
          <div><label class="text-xs font-bold text-gray-500">Batch No</label>
          <input type="text" id="editBatch" class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-700"></div>
          
          <button onclick="saveEdit()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">Update Data</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentCategory = 'Healthcare';
    let rawProductionData = []; 
    let offDaysList = []; 
    let usersList = [];
    let weeklyChart = null;

    let localUsers = [
        {username: 'admin', role: 'Admin', password: '123'},
        {username: 'manager', role: 'Manager', password: '123'},
        {username: 'planner', role: 'Planner', password: '123'},
        {username: 'operator', role: 'Operator', password: '123'}
    ];

    window.onload = function() {
        if (localStorage.theme === 'dark') document.documentElement.classList.add('dark');
        
        const isGAS = typeof google !== 'undefined' && google.script;
        if (!isGAS) {
            rawProductionData = getMockData();
            offDaysList = ['2025-11-22'];
            usersList = localUsers;
            loadCategory('Healthcare');
        } else {
            google.script.run.withSuccessHandler(data => {
                rawProductionData = JSON.parse(data);
                loadCategory('Healthcare');
                updateLastUpdateInfo(); // Call after data loaded
            }).getProductionData();
            
            google.script.run.withSuccessHandler(days => {
                offDaysList = JSON.parse(days);
            }).getOffDays();

            google.script.run.withSuccessHandler(u => {
                usersList = JSON.parse(u);
            }).getUsers();
        }

        const savedUser = localStorage.getItem('mfg_user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            updateUIForUser();
        }
    };

    function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        renderDashboard(); 
    }

    function runGoogleScript(fnName, params, onSuccess) {
        if (typeof google !== 'undefined' && google.script) {
            google.script.run.withSuccessHandler(onSuccess)[fnName](params);
        } else {
            if (fnName === 'submitData') {
                const newRow = JSON.parse(params);
                newRow.id = Date.now();
                newRow.user = currentUser ? currentUser.username : 'local';
                newRow.timestamp = new Date();
                rawProductionData.push(newRow);
                onSuccess({success: true});
            } else if (fnName === 'updateData') {
                const p = JSON.parse(params);
                const row = rawProductionData.find(r => r.id == p.id);
                if(row) { row.qty = p.qty; if(p.batch) row.batch = p.batch; }
                onSuccess({success: true});
            } else if (fnName === 'saveOffDays') {
                offDaysList = JSON.parse(params);
                onSuccess({success: true});
            } else if (fnName === 'addUser') {
                usersList.push(JSON.parse(params));
                onSuccess({success: true});
            } else if (fnName === 'deleteUser') {
                const uName = JSON.parse(params).username;
                usersList = usersList.filter(u => u.username !== uName);
                onSuccess({success: true});
            }
        }
    }

    function getMockData() {
        return [
            { id: 1, date: '2025-11-20', type: 'Plan', category: 'Healthcare', process: 'Mixing', product: 'Vitamin C', qty: 1000, manpower: 0, user: 'plan1', timestamp: '2025-11-20T08:00:00' },
            { id: 2, date: '2025-11-20', type: 'Actual', category: 'Healthcare', process: 'Mixing', product: 'Vitamin C', qty: 950, batch: 'B001', manpower: 5, user: 'op1', timestamp: '2025-11-20T17:00:00' },
        ];
    }

    function loadCategory(cat) {
        currentCategory = cat;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-indigo-600', 'text-white'));
        document.getElementById('nav-'+cat).classList.add('bg-indigo-600', 'text-white');
        document.getElementById('pageTitle').innerText = cat + " Dashboard";
        renderDashboard();
    }

    function fetchData() {
        const loader = document.getElementById('loader');
        loader.classList.remove('hidden');
        document.getElementById('tableContainer').innerHTML = '';
        
        if (typeof google !== 'undefined' && google.script) {
            google.script.run.withSuccessHandler(data => {
                rawProductionData = JSON.parse(data);
                loader.classList.add('hidden');
                renderDashboard();
                updateLastUpdateInfo();
            }).getProductionData();
        } else {
            setTimeout(() => {
                loader.classList.add('hidden');
                renderDashboard();
                updateLastUpdateInfo();
            }, 500);
        }
    }
    
    // Logic to calculate Last Updated
    function updateLastUpdateInfo() {
        if (!rawProductionData || rawProductionData.length === 0) {
            document.getElementById('lastUpdateUser').innerText = '-';
            document.getElementById('lastUpdateTime').innerText = '-';
            return;
        }

        // Sort by timestamp descending
        const sorted = [...rawProductionData].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        const last = sorted[0];

        if (last && last.timestamp) {
            const date = new Date(last.timestamp);
            document.getElementById('lastUpdateUser').innerText = last.user || 'Unknown';
            document.getElementById('lastUpdateTime').innerText = date.toLocaleString();
        }
    }

    function renderDashboard() {
        const filtered = rawProductionData.filter(d => d.category === currentCategory);
        let planTotal = 0, actualTotal = 0;
        filtered.forEach(d => {
            if (d.type === 'Plan') planTotal += Number(d.qty);
            if (d.type === 'Actual') actualTotal += Number(d.qty);
        });
        document.getElementById('kpiTarget').innerText = planTotal.toLocaleString();
        document.getElementById('kpiActual').innerText = actualTotal.toLocaleString();
        renderTable(filtered);
        renderChart(filtered);
    }

    function consolidateForDate(dailyData) {
        const map = {};
        dailyData.forEach(item => {
            const key = item.process + '|' + item.product; 
            if (!map[key]) {
                map[key] = {
                    process: item.process,
                    product: item.product,
                    planQty: 0,
                    actualQty: 0,
                    manpower: 0,
                    batch: '',
                    planId: null,
                    actualId: null,
                    date: item.date 
                };
            }
            if (item.type === 'Plan') {
                map[key].planQty += Number(item.qty);
                map[key].planId = item.id;
            } else {
                map[key].actualQty += Number(item.qty);
                map[key].manpower = Math.max(map[key].manpower, Number(item.manpower));
                map[key].batch = item.batch || map[key].batch;
                map[key].actualId = item.id;
            }
        });
        return Object.values(map);
    }

    function renderTable(data) {
        const container = document.getElementById('tableContainer');
        const empty = document.getElementById('emptyState');
        container.innerHTML = '';

        const dataDates = data.map(d => d.date);
        const allDates = [...new Set([...dataDates, ...offDaysList])];
        allDates.sort((a,b) => new Date(b) - new Date(a));

        if (allDates.length === 0) { empty.classList.remove('hidden'); return; }
        empty.classList.add('hidden');

        let lastMonth = '';

        allDates.forEach(date => {
            const dateObj = new Date(date);
            const monthStr = dateObj.toLocaleString('default', { month: 'short', year: 'numeric' }).toUpperCase();
            
            if (monthStr !== lastMonth) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-header';
                monthDiv.innerHTML = `<span>${monthStr}</span>`;
                container.appendChild(monthDiv);
                lastMonth = monthStr;
            }

            const isOffDay = offDaysList.includes(date);
            const dailyRaw = data.filter(d => d.date === date);
            const dailyData = consolidateForDate(dailyRaw);
            
            if (dailyData.length === 0 && !isOffDay) return;

            const card = document.createElement('div');
            card.className = `glass-panel rounded-xl overflow-hidden mb-2 border-l-4 ${isOffDay ? 'border-red-500' : 'border-indigo-500'}`;
            
            const headerClass = isOffDay 
                ? 'off-day-header p-2 flex justify-between items-center' 
                : 'bg-gray-100 dark:bg-slate-800 p-2 flex justify-between items-center';
            
            const headerTextColor = isOffDay ? 'text-white' : 'text-gray-700 dark:text-gray-200';
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            
            const headerText = isOffDay 
                ? `<span class="font-bold text-sm"><i class="fas fa-calendar-times mr-2"></i>${date} (${dayName}) - OFF DAY</span>` 
                : `<span class="font-bold text-sm"><i class="fas fa-calendar-day mr-2 text-indigo-500"></i>${date} <span class="text-xs text-gray-500 ml-2 font-normal uppercase">${dayName}</span></span>`;

            const totalDailyActual = dailyData.reduce((acc, curr) => acc + curr.actualQty, 0);

            card.innerHTML = `
                <div class="${headerClass} ${headerTextColor}">
                    ${headerText}
                    ${dailyData.length > 0 ? `<span class="text-xs font-bold px-2 py-0.5 rounded bg-white/20">Total Actual: ${totalDailyActual}</span>` : ''}
                </div>
            `;

            if (dailyData.length > 0) {
                const table = document.createElement('table');
                table.className = `w-full text-sm ${isOffDay ? 'off-day-body' : ''}`;
                table.innerHTML = `
                    <thead class="bg-gray-50 dark:bg-slate-900/50 text-xs uppercase text-gray-500 border-b dark:border-slate-700">
                        <tr>
                            <th class="p-2 text-left">Process</th>
                            <th class="p-2 text-left">Product</th>
                            <th class="p-2 text-right">Plan Quantity</th>
                            <th class="p-2 text-right">Actual Quantity</th>
                            <th class="p-2 text-center">Efficiency</th>
                            <th class="p-2 text-center">Batch No</th>
                            <th class="p-2 text-center">Manpower</th>
                            ${(currentUser && (currentUser.role === 'Manager' || currentUser.role === 'Admin')) ? '<th class="p-2 text-center">Action</th>' : ''}
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-slate-700"></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                dailyData.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    let eff = 0;
                    let effColor = 'text-gray-400';
                    if (row.planQty > 0 && row.actualQty > 0) {
                        eff = Math.round((row.actualQty / row.planQty) * 100);
                        if (eff >= 80) effColor = 'text-green-600 font-bold'; 
                        else effColor = 'text-red-600 font-bold'; 
                    }

                    tr.innerHTML = `
                        <td class="p-2"><span class="px-2 py-0.5 bg-indigo-50 text-indigo-700 rounded text-xs font-bold">${row.process}</span></td>
                        <td class="p-2 font-medium">${row.product}</td>
                        <td class="p-2 text-right font-mono font-bold text-blue-600">${row.planQty}</td>
                        <td class="p-2 text-right font-mono font-bold text-green-600">${row.actualQty}</td>
                        <td class="p-2 text-center ${effColor}">${eff}%</td>
                        <td class="p-2 text-center font-mono text-xs text-gray-500">${row.batch || '-'}</td>
                        <td class="p-2 text-center">${row.manpower}</td>
                        ${(currentUser && (currentUser.role === 'Manager' || currentUser.role === 'Admin')) ? `
                        <td class="p-2 text-center">
                            <button onclick="openEditModalFromRow('${row.date}', '${row.process}', '${row.product}', '${row.planId}', '${row.actualId}', ${row.planQty}, ${row.actualQty}, '${row.batch}')" class="text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button>
                        </td>` : ''}
                    `;
                    tbody.appendChild(tr);
                });
                card.appendChild(table);
            } else {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = "p-2 text-center text-xs text-gray-500 italic bg-red-50 dark:bg-red-900/20";
                emptyMsg.innerText = "No Production Data";
                card.appendChild(emptyMsg);
            }
            container.appendChild(card);
        });
    }

    function renderChart(data) {
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        if (weeklyChart) weeklyChart.destroy();
        const processes = [...new Set(data.map(d => d.process))];
        const planData = processes.map(p => data.filter(d => d.process === p && d.type === 'Plan').reduce((a,b)=>a+Number(b.qty),0));
        const actualData = processes.map(p => data.filter(d => d.process === p && d.type === 'Actual').reduce((a,b)=>a+Number(b.qty),0));

        weeklyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: processes,
                datasets: [
                    { label: 'Plan', data: planData, backgroundColor: '#3b82f6' },
                    { label: 'Actual', data: actualData, backgroundColor: '#10b981' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
        });
    }

    // Input & Edit Logic
    function openInputModal() { 
        document.getElementById('inputDate').valueAsDate = new Date(); 
        document.getElementById('inputModal').classList.remove('hidden');
        
        // --- ROLE BASED TAB LOGIC ---
        const tabPlanBtn = document.getElementById('tabPlan');
        const tabActualBtn = document.getElementById('tabActual');
        
        // Reset visibility
        tabPlanBtn.style.display = 'block';
        tabActualBtn.style.display = 'block';

        if (currentUser.role === 'Planner') {
            tabActualBtn.style.display = 'none'; // Hide Actual
            switchInputTab('Plan');
        } else if (currentUser.role === 'Operator') {
            tabPlanBtn.style.display = 'none'; // Hide Plan
            switchInputTab('Actual');
        } else {
            // Manager/Admin see both, default to Plan
            switchInputTab('Plan');
        }
    }

    function closeInputModal() { document.getElementById('inputModal').classList.add('hidden'); }
    
    function switchInputTab(type) {
        document.getElementById('inputType').value = type;
        const p = document.getElementById('tabPlan');
        const a = document.getElementById('tabActual');
        const f = document.getElementById('actualFields');
        const m = document.getElementById('manpowerFieldContainer'); // Logic for Manpower

        if (type === 'Plan') { 
            // Activate Plan Tab
            p.classList.add('bg-indigo-50','text-indigo-700','border-b-2','border-indigo-600'); 
            p.classList.remove('text-gray-500'); 
            a.classList.remove('bg-emerald-50','text-emerald-700','border-b-2','border-emerald-600'); 
            a.classList.add('text-gray-500'); 
            
            // Hide fields not needed for Plan
            f.classList.add('hidden'); // Batch
            m.classList.add('hidden'); // Manpower HIDDEN for Plan
        } else { 
            // Activate Actual Tab
            a.classList.add('bg-emerald-50','text-emerald-700','border-b-2','border-emerald-600'); 
            a.classList.remove('text-gray-500'); 
            p.classList.remove('bg-indigo-50','text-indigo-700','border-b-2','border-indigo-600'); 
            p.classList.add('text-gray-500'); 
            
            // Show fields needed for Actual
            f.classList.remove('hidden'); // Batch
            m.classList.remove('hidden'); // Manpower SHOWN for Actual
        }
    }
    
    function submitData() {
        const payload = {
            date: document.getElementById('inputDate').value,
            category: document.getElementById('inputCategory').value,
            process: document.getElementById('inputProcess').value,
            product: document.getElementById('inputProduct').value,
            qty: document.getElementById('inputQty').value,
            manpower: document.getElementById('inputManpower').value,
            type: document.getElementById('inputType').value,
            batch: document.getElementById('inputBatch').value,
            user: currentUser ? currentUser.username : 'Unknown' // Send User
        };
        if(!payload.date || !payload.product || !payload.qty) { alert("Please fill required fields"); return; }
        runGoogleScript('submitData', JSON.stringify(payload), (res) => { alert('Data Saved!'); closeInputModal(); fetchData(); });
    }

    function openEditModalFromRow(date, process, product, planId, actualId, planQty, actualQty, batch) {
        document.getElementById('editDateDisplay').value = date;
        document.getElementById('editProduct').value = product;
        document.getElementById('editPlanQty').value = planQty;
        document.getElementById('editActualQty').value = actualQty;
        document.getElementById('editBatch').value = batch;
        document.getElementById('editPlanId').value = planId !== 'null' ? planId : '';
        document.getElementById('editActualId').value = actualId !== 'null' ? actualId : '';
        document.getElementById('editModal').classList.remove('hidden');
    }
    function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }
    function saveEdit() {
        const planId = document.getElementById('editPlanId').value;
        const actualId = document.getElementById('editActualId').value;
        const updates = [];
        if (planId) updates.push({ id: planId, qty: document.getElementById('editPlanQty').value, type: 'Plan' });
        if (actualId) updates.push({ id: actualId, qty: document.getElementById('editActualQty').value, batch: document.getElementById('editBatch').value, type: 'Actual' });
        
        let completed = 0;
        if (updates.length === 0) { closeEditModal(); return; }
        updates.forEach(upd => {
            const payload = { id: upd.id, qty: upd.qty, batch: upd.batch };
            runGoogleScript('updateData', JSON.stringify(payload), (res) => {
                completed++;
                if (completed === updates.length) { alert("Data Updated"); fetchData(); closeEditModal(); }
            });
        });
    }

    // Off Day Logic
    function openOffDayModal() { document.getElementById('offDayModal').classList.remove('hidden'); renderOffDayList(); }
    function closeOffDayModal() { document.getElementById('offDayModal').classList.add('hidden'); }
    function addOffDay() { const date = document.getElementById('offDayPicker').value; if(date && !offDaysList.includes(date)) { offDaysList.push(date); offDaysList.sort(); renderOffDayList(); } }
    function removeOffDay(date) { offDaysList = offDaysList.filter(d => d !== date); renderOffDayList(); }
    function renderOffDayList() {
        document.getElementById('offDayList').innerHTML = offDaysList.map(d => `
            <li class="flex justify-between items-center p-2 bg-white dark:bg-slate-800 border rounded"><span>${d}</span><button onclick="removeOffDay('${d}')" class="text-red-500"><i class="fas fa-trash"></i></button></li>
        `).join('');
    }
    function saveOffDays() { runGoogleScript('saveOffDays', JSON.stringify(offDaysList), (res) => { alert('Off Days Set!'); closeOffDayModal(); fetchData(); }); }

    // Admin: User Management Logic
    function openUserModal() { document.getElementById('userModal').classList.remove('hidden'); renderUserList(); }
    function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); }
    function renderUserList() {
        const tbody = document.getElementById('userListBody');
        tbody.innerHTML = '';
        usersList.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-2">${u.username}</td><td class="p-2"><span class="px-2 py-1 rounded bg-gray-200 text-xs font-bold">${u.role}</span></td><td class="p-2 text-center"><button onclick="deleteUser('${u.username}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>`;
            tbody.appendChild(tr);
        });
    }
    function addNewUser() {
        const u = document.getElementById('newUsername').value;
        const p = document.getElementById('newPassword').value;
        const r = document.getElementById('newRole').value;
        if(u && p) {
            runGoogleScript('addUser', JSON.stringify({username: u, password: p, role: r}), (res) => {
                alert('User added');
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
                renderUserList();
            });
        } else alert("Fill all fields");
    }
    function deleteUser(username) {
        if(confirm("Delete user " + username + "?")) {
            runGoogleScript('deleteUser', JSON.stringify({username: username}), (res) => {
                alert('User deleted');
                renderUserList();
            });
        }
    }

    // Login Logic
    function openLoginModal() { document.getElementById('loginModal').classList.remove('hidden'); }
    function closeLoginModal() { document.getElementById('loginModal').classList.add('hidden'); }
    function performLogin() {
        const u = document.getElementById('username').value.toLowerCase();
        const p = document.getElementById('password').value;
        
        const found = usersList.find(user => user.username.toLowerCase() === u && user.password === p);
        
        if (found) {
            currentUser = { username: found.username, role: found.role };
            localStorage.setItem('mfg_user', JSON.stringify(currentUser));
            closeLoginModal();
            updateUIForUser();
            alert(`Welcome ${found.role}`);
        } else {
            alert('Invalid login');
        }
    }
    function logout() { currentUser = null; localStorage.removeItem('mfg_user'); updateUIForUser(); renderDashboard(); }
    
    function updateUIForUser() {
        const profile = document.getElementById('userProfileSection');
        const inputBtn = document.getElementById('inputDataBtn');
        const managerControls = document.getElementById('managerControls');
        const adminControls = document.getElementById('adminControls');
        
        if (currentUser) {
            profile.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold">${currentUser.username[0].toUpperCase()}</div>
                    <div class="flex-1">
                        <p class="text-sm font-bold">${currentUser.username}</p>
                        <p class="text-xs text-indigo-400">${currentUser.role}</p>
                    </div>
                    <button onclick="logout()" class="text-red-500 text-xs hover:underline">Logout</button>
                </div>
            `;
            
            inputBtn.classList.remove('hidden');
            
            // Permissions
            if(currentUser.role === 'Manager' || currentUser.role === 'Admin') managerControls.classList.remove('hidden');
            else managerControls.classList.add('hidden');

            if(currentUser.role === 'Admin') adminControls.classList.remove('hidden');
            else adminControls.classList.add('hidden');
            
            renderDashboard(); 
        } else {
            profile.innerHTML = `<button onclick="openLoginModal()" class="w-full px-3 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition">Login System</button>`;
            inputBtn.classList.add('hidden');
            managerControls.classList.add('hidden');
            adminControls.classList.add('hidden');
        }
    }
  </script>
</body>
</html>
