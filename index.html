<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Halagel Production Dashboard</title> <!-- DIKEMASKINI: Tajuk Tab Browser -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            indigo: { 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
            slate: { 850: '#151e2e', 900: '#0f172a' },
            emerald: { 50: '#ecfdf5', 600: '#059669' },
            purple: { 400: '#c084fc', 600: '#9333ea' },
            blue: { 50: '#eff6ff', 100: '#dbeafe', 600: '#2563eb' },
            amber: { 50: '#fffbeb', 600: '#d97706' }
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    body { transition: background-color 0.3s, color 0.3s; }
    .glass-panel { 
        background: white; 
        backdrop-filter: blur(12px); 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .dark .glass-panel { 
        background: rgba(30, 41, 59, 0.9); 
        border: 1px solid rgba(255, 255, 255, 0.05); 
    }
    /* Month Header */
    .month-header {
        position: relative;
        text-align: center;
        margin: 1.5rem 0 1rem 0;
    }
    .month-header span {
        background: #e2e8f0;
        padding: 0.3rem 1rem;
        border-radius: 9999px;
        font-weight: 800;
        font-size: 0.8rem;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: relative;
        z-index: 10;
    }
    .dark .month-header span {
        background: #334155;
        color: #e2e8f0;
    }
    .month-header::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 1px;
        background: #cbd5e1;
        z-index: 0;
    }
    .dark .month-header::before {
        background: #334155;
    }

    /* Off Day Styling */
    .off-day-header {
        background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%) !important;
        color: white;
    }
    .off-day-body {
        background-color: #fef2f2;
    }
    .dark .off-day-body {
        background-color: #450a0a;
        opacity: 0.3;
    }
  </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 font-sans antialiased">

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="hidden md:flex flex-col w-64 bg-white dark:bg-slate-850 border-r border-gray-200 dark:border-slate-700 z-30 shadow-md">
      <div class="p-6 flex items-center gap-3 border-b border-gray-100 dark:border-slate-800">
        
        <!-- START: BLOK LOGO MENGGUNAKAN IMG SRC -->
        <div class="w-10 h-10 flex items-center justify-center">
          <!-- GANTIKAN URL DI BAWAH DENGAN URL LOGO ANDA -->
          <img src="data:image/png;base64,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" 
               alt="Logo Syarikat" 
               class="w-full h-full object-contain rounded-lg border border-indigo-200 dark:border-indigo-900">
        </div>
        <!-- END: BLOK LOGO MENGGUNAKAN IMG SRC -->

        <!-- NAMA SISTEM -->
        <div>
          <h1 class="font-extrabold text-xl tracking-tight">HALA<span class="text-green-600">GEL</span></h1>
          <p class="text-[10px] font-bold text-slate-400 uppercase">Sistem Pengurusan V1</p>
        </div>

      </div>
      
      <nav class="flex-1 px-4 space-y-1 mt-4">
        <button onclick="loadCategory('Healthcare')" id="nav-Healthcare" class="nav-btn group flex items-center w-full gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-indigo-50 dark:hover:bg-slate-800 transition">
          <i class="fas fa-medkit w-5"></i> Healthcare
        </button>
        <button onclick="loadCategory('Toothpaste')" id="nav-Toothpaste" class="nav-btn group flex items-center w-full gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-indigo-50 dark:hover:bg-slate-800 transition">
          <i class="fas fa-tooth w-5"></i> Toothpaste
        </button>
        <button onclick="loadCategory('Rocksalt')" id="nav-Rocksalt" class="nav-btn group flex items-center w-full gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-indigo-50 dark:hover:bg-slate-800 transition">
          <i class="fas fa-cube w-5"></i> Rocksalt
        </button>
        
        <!-- Last Updated Info -->
        <div class="mt-4 px-4 py-3 bg-gray-50 dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Last Update</p>
            <div class="flex items-center gap-2 mb-1">
                <i class="fas fa-user-circle text-indigo-500 text-xs"></i>
                <p id="lastUpdateUser" class="text-xs font-bold truncate">-</p>
            </div>
            <div class="flex items-center gap-2">
                <i class="fas fa-clock text-gray-400 text-xs"></i>
                <p id="lastUpdateTime" class="text-[10px] text-gray-500 font-mono">-</p>
            </div>
        </div>

        <!-- Manager & Admin Settings -->
        <div id="managerControls" class="hidden mt-4 pt-4 border-t border-gray-200 dark:border-slate-700">
          <p class="px-4 text-xs font-bold text-gray-400 uppercase mb-2">Manager</p>
          <button onclick="openOffDayModal()" class="group flex items-center w-full gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-red-50 dark:hover:bg-slate-800 transition text-red-600">
            <i class="fas fa-calendar-times w-5"></i> Set Off Days
          </button>
        </div>

        <div id="adminControls" class="hidden mt-2">
           <p class="px-4 text-xs font-bold text-gray-400 uppercase mb-2">Admin</p>
           <button onclick="openUserModal()" class="group flex items-center w-full gap-3 px-4 py-3 text-sm font-medium rounded-xl hover:bg-purple-50 dark:hover:bg-slate-800 transition text-purple-600">
            <i class="fas fa-users-cog w-5"></i> Manage Users
          </button>
        </div>
      </nav>

      <!-- User Profile -->
      <div class="p-4 border-t border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900/50">
        <div id="userProfileSection" class="flex items-center gap-3 justify-between">
           <button onclick="openLoginModal()" class="w-full px-3 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30">Login System</button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
      <!-- Header -->
      <header class="h-16 bg-white dark:bg-slate-850 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between px-6 z-20">
        <div class="flex items-center gap-4">
            <h2 id="pageTitle" class="text-xl font-extrabold text-gray-800 dark:text-white">Dashboard</h2>
        </div>
        <div class="flex items-center gap-3">
            <button id="inputDataBtn" onclick="openInputModal()" class="hidden px-4 py-2 bg-emerald-600 text-white text-sm font-bold rounded-lg hover:bg-emerald-700 transition flex items-center gap-2">
                <i class="fas fa-plus"></i> Input Data
            </button>
            <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center">
              <i class="fas fa-moon dark:hidden text-gray-600"></i>
              <i class="fas fa-sun hidden dark:block text-yellow-500"></i>
            </button>
        </div>
      </header>

      <!-- Dashboard Content -->
      <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-panel p-6 rounded-2xl border-l-4 border-blue-500 flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-slate-500">Total Plan Quantity</p>
                    <h3 id="kpiTarget" class="text-3xl font-extrabold mt-1 text-blue-600 dark:text-blue-400">0</h3>
                </div>
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/50 rounded-full flex items-center justify-center text-blue-600">
                    <i class="fas fa-clipboard-list text-xl"></i>
                </div>
            </div>
            <div class="glass-panel p-6 rounded-2xl border-l-4 border-green-500 flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-slate-500">Total Actual Quantity</p>
                    <h3 id="kpiActual" class="text-3xl font-extrabold mt-1 text-green-600 dark:text-green-400">0</h3>
                </div>
                <div class="w-12 h-12 bg-green-100 dark:bg-green-900/50 rounded-full flex items-center justify-center text-green-600">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="glass-panel rounded-2xl p-5">
            <h3 class="font-bold text-lg mb-4">Weekly Production</h3>
            <div class="h-64"><canvas id="weeklyChart"></canvas></div>
        </div>

        <!-- Production Log -->
        <div class="glass-panel rounded-2xl overflow-hidden flex flex-col min-h-[400px]">
            <div class="p-5 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-table mr-2"></i>Production Log</h3>
                <button onclick="fetchData()" class="text-sm text-indigo-600 font-semibold hover:underline"><i class="fas fa-sync-alt mr-1"></i> Refresh</button>
            </div>
            <div id="loader" class="hidden flex justify-center items-center h-48"><i class="fas fa-circle-notch fa-spin text-3xl text-indigo-500"></i></div>
            <div id="tableContainer" class="p-4 space-y-4"></div>
            <div id="emptyState" class="hidden flex justify-center items-center h-48 text-slate-400">No data found.</div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL: Login -->
  <div id="loginModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-96 shadow-2xl relative">
      <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      <h3 class="text-2xl font-bold text-center mb-6">Login</h3>
      <input type="text" id="username" class="w-full p-3 mb-4 rounded bg-gray-50 dark:bg-slate-900 border dark:border-slate-700" placeholder="Username">
      <input type="password" id="password" class="w-full p-3 mb-6 rounded bg-gray-50 dark:bg-slate-900 border dark:border-slate-700" placeholder="Password">
      <button onclick="performLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Log In</button>
    </div>
  </div>

  <!-- MODAL: User Management (Admin Only) -->
  <div id="userModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-[500px] shadow-2xl max-h-[80vh] flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-purple-600">User Management</h3>
        <button onclick="closeUserModal()" class="text-gray-500"><i class="fas fa-times"></i></button>
      </div>
      
      <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg mb-4">
          <h4 class="text-sm font-bold mb-2">Add New User</h4>
          <div class="grid grid-cols-3 gap-2 mb-2">
              <input type="text" id="newUsername" placeholder="Username" class="p-2 text-sm border rounded dark:bg-slate-900 dark:border-slate-700">
              <input type="password" id="newPassword" placeholder="Password" class="p-2 text-sm border rounded dark:bg-slate-900 dark:border-slate-700">
              <select id="newRole" class="p-2 text-sm border rounded dark:bg-slate-900 dark:border-slate-700">
                  <option value="Operator">Operator</option>
                  <option value="Planner">Planner</option>
                  <option value="Manager">Manager</option>
                  <option value="Admin">Admin</option>
              </select>
          </div>
          <button onclick="addNewUser()" class="w-full bg-purple-600 text-white py-2 rounded text-sm font-bold hover:bg-purple-700">Add User</button>
      </div>

      <div class="flex-1 overflow-y-auto">
          <table class="w-full text-sm text-left">
              <thead class="bg-gray-100 dark:bg-slate-700 font-bold">
                  <tr>
                      <th class="p-2">Username</th>
                      <th class="p-2">Role</th>
                      <th class="p-2 text-center">Action</th>
                  </tr>
              </thead>
              <tbody id="userListBody" class="divide-y divide-gray-200 dark:divide-slate-700"></tbody>
          </table>
      </div>
    </div>
  </div>

  <!-- MODAL: Input Data -->
  <div id="inputModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-0 w-[500px] shadow-2xl overflow-hidden">
      <!-- Tabs -->
      <div class="flex border-b border-gray-200 dark:border-slate-700">
          <button onclick="switchInputTab('Plan')" id="tabPlan" class="flex-1 py-4 font-bold text-center bg-indigo-50 text-indigo-700 transition">Input Plan</button>
          <button onclick="switchInputTab('Actual')" id="tabActual" class="flex-1 py-4 font-bold text-center text-gray-500 hover:bg-gray-50 transition">Input Actual</button>
      </div>
      
      <div class="p-6 relative">
          <button onclick="closeInputModal()" class="absolute top-2 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
          <form id="inputForm" class="space-y-4">
              <input type="hidden" id="inputType" value="Plan">
              
              <div>
                  <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Date</label>
                  <input type="date" id="inputDate" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700">
              </div>

              <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Category</label>
                    <select id="inputCategory" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700">
                        <option value="Healthcare">Healthcare</option>
                        <option value="Toothpaste">Toothpaste</option>
                        <option value="Rocksalt">Rocksalt</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Process</label>
                    <select id="inputProcess" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700">
                        <option value="Mixing">Mixing</option>
                        <option value="Filling">Filling</option>
                        <option value="Encapsulation">Encapsulation</option>
                        <option value="Packing">Packing</option>
                        <option value="Sorting">Sorting</option>
                    </select>
                  </div>
              </div>

              <div>
                  <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Product Name</label>
                  <input type="text" id="inputProduct" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700" placeholder="Product Name">
              </div>

              <div class="grid grid-cols-2 gap-4">
                  <div>
                      <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Quantity</label>
                      <input type="number" id="inputQty" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700" placeholder="0">
                  </div>
                  <div id="manpowerFieldContainer">
                      <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Manpower</label>
                      <input type="number" id="inputManpower" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700" value="5">
                  </div>
              </div>

              <div id="actualFields" class="hidden">
                  <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Batch No</label>
                  <input type="text" id="inputBatch" class="w-full p-2 rounded border dark:bg-slate-900 dark:border-slate-700" placeholder="Batch No">
              </div>

              <button type="button" onclick="submitData()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 mt-4">
                  <i class="fas fa-paper-plane mr-2"></i> Submit Data
              </button>
          </form>
      </div>
    </div>
  </div>

  <!-- MODAL: Off Day Calendar -->
  <div id="offDayModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-96 shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Set Off Days</h3>
        <button onclick="closeOffDayModal()" class="text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
      </div>
      
      <div class="space-y-4">
        <div class="flex gap-2">
            <input type="date" id="offDayPicker" class="flex-1 p-2 rounded border dark:bg-slate-900 dark:border-slate-700">
            <button onclick="addOffDay()" class="px-4 bg-indigo-600 text-white rounded font-bold">Add</button>
        </div>
        
        <div class="h-40 overflow-y-auto border rounded p-2 dark:border-slate-700 bg-gray-50 dark:bg-slate-900">
            <ul id="offDayList" class="space-y-2 text-sm"></ul>
        </div>
        
        <button onclick="saveOffDays()" class="w-full bg-emerald-600 text-white py-2 rounded font-bold hover:bg-emerald-700">Okay (Save)</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Edit Data -->
  <div id="editModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-[450px] shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-indigo-600">Edit Data</h3>
        <button onclick="closeEditModal()" class="text-gray-500"><i class="fas fa-times"></i></button>
      </div>
      <div class="space-y-3">
          <input type="hidden" id="editPlanId"> 
          <input type="hidden" id="editActualId"> 
          
          <div><label class="text-xs font-bold text-gray-500">Date</label>
          <input type="text" id="editDateDisplay" disabled class="w-full p-2 bg-gray-100 dark:bg-slate-700 rounded text-gray-500"></div>
          
          <div><label class="text-xs font-bold text-gray-500">Product</label>
          <input type="text" id="editProduct" disabled class="w-full p-2 bg-gray-100 dark:bg-slate-700 rounded text-gray-500"></div>

          <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-blue-600">Plan Qty</label>
                <input type="number" id="editPlanQty" class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-700">
              </div>
              <div>
                <label class="text-xs font-bold text-green-600">Actual Qty</label>
                <input type="number" id="editActualQty" class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-700">
              </div>
          </div>
          
          <div><label class="text-xs font-bold text-gray-500">Batch No</label>
          <input type="text" id="editBatch" class="w-full p-2 border rounded dark:bg-slate-900 dark:border-slate-700"></div>
          
          <button onclick="saveEdit()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">Update Data</button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentCategory = 'Healthcare';
    let rawProductionData = []; 
    let offDaysList = []; 
    let usersList = [];
    let weeklyChart = null;

    let localUsers = [
        {username: 'admin', role: 'Admin', password: '123'},
        {username: 'manager', role: 'Manager', password: '123'},
        {username: 'planner', role: 'Planner', password: '123'},
        {username: 'operator', role: 'Operator', password: '123'}
    ];

    window.onload = function() {
        if (localStorage.theme === 'dark') document.documentElement.classList.add('dark');
        
        const isGAS = typeof google !== 'undefined' && google.script;
        if (!isGAS) {
            rawProductionData = getMockData();
            offDaysList = ['2025-11-22'];
            usersList = localUsers;
            loadCategory('Healthcare');
        } else {
            google.script.run.withSuccessHandler(data => {
                rawProductionData = JSON.parse(data);
                loadCategory('Healthcare');
                updateLastUpdateInfo(); // Call after data loaded
            }).getProductionData();
            
            google.script.run.withSuccessHandler(days => {
                offDaysList = JSON.parse(days);
            }).getOffDays();

            google.script.run.withSuccessHandler(u => {
                usersList = JSON.parse(u);
            }).getUsers();
        }

        const savedUser = localStorage.getItem('mfg_user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            updateUIForUser();
        }
    };

    function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
        localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        renderDashboard(); 
    }

    function runGoogleScript(fnName, params, onSuccess) {
        if (typeof google !== 'undefined' && google.script) {
            google.script.run.withSuccessHandler(onSuccess)[fnName](params);
        } else {
            if (fnName === 'submitData') {
                const newRow = JSON.parse(params);
                newRow.id = Date.now();
                newRow.user = currentUser ? currentUser.username : 'local';
                newRow.timestamp = new Date();
                rawProductionData.push(newRow);
                onSuccess({success: true});
            } else if (fnName === 'updateData') {
                const p = JSON.parse(params);
                const row = rawProductionData.find(r => r.id == p.id);
                if(row) { row.qty = p.qty; if(p.batch) row.batch = p.batch; }
                onSuccess({success: true});
            } else if (fnName === 'saveOffDays') {
                offDaysList = JSON.parse(params);
                onSuccess({success: true});
            } else if (fnName === 'addUser') {
                usersList.push(JSON.parse(params));
                onSuccess({success: true});
            } else if (fnName === 'deleteUser') {
                const uName = JSON.parse(params).username;
                usersList = usersList.filter(u => u.username !== uName);
                onSuccess({success: true});
            }
        }
    }

    function getMockData() {
        // Mock data to simulate production records
        return [
            { id: 1, date: '2025-11-20', type: 'Plan', category: 'Healthcare', process: 'Mixing', product: 'Vitamin C', qty: 1000, manpower: 0, user: 'plan1', timestamp: '2025-11-20T08:00:00' },
            { id: 2, date: '2025-11-20', type: 'Actual', category: 'Healthcare', process: 'Mixing', product: 'Vitamin C', qty: 950, batch: 'B001', manpower: 5, user: 'op1', timestamp: '2025-11-20T17:00:00' },
            { id: 3, date: '2025-11-21', type: 'Plan', category: 'Healthcare', process: 'Filling', product: 'Vitamin E', qty: 500, manpower: 0, user: 'plan1', timestamp: '2025-11-21T08:00:00' },
            { id: 4, date: '2025-11-21', type: 'Actual', category: 'Healthcare', process: 'Filling', product: 'Vitamin E', qty: 450, batch: 'B002', manpower: 4, user: 'op2', timestamp: '2025-11-21T16:00:00' },
            { id: 5, date: '2025-11-19', type: 'Plan', category: 'Toothpaste', process: 'Mixing', product: 'Toothpaste Mint', qty: 1200, manpower: 0, user: 'plan1', timestamp: '2025-11-19T08:00:00' },
            { id: 6, date: '2025-11-19', type: 'Actual', category: 'Toothpaste', process: 'Mixing', product: 'Toothpaste Mint', qty: 1250, batch: 'TM-101', manpower: 7, user: 'op2', timestamp: '2025-11-19T16:00:00' },
        ];
    }

    function loadCategory(cat) {
        currentCategory = cat;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-indigo-600', 'text-white'));
        document.getElementById('nav-'+cat).classList.add('bg-indigo-600', 'text-white');
        document.getElementById('pageTitle').innerText = cat + " Dashboard";
        renderDashboard();
    }

    function fetchData() {
        const loader = document.getElementById('loader');
        loader.classList.remove('hidden');
        document.getElementById('tableContainer').innerHTML = '';
        
        if (typeof google !== 'undefined' && google.script) {
            google.script.run.withSuccessHandler(data => {
                rawProductionData = JSON.parse(data);
                loader.classList.add('hidden');
                renderDashboard();
                updateLastUpdateInfo();
            }).getProductionData();
        } else {
            setTimeout(() => {
                loader.classList.add('hidden');
                renderDashboard();
                updateLastUpdateInfo();
            }, 500);
        }
    }
    
    // Logic to calculate Last Updated
    function updateLastUpdateInfo() {
        if (!rawProductionData || rawProductionData.length === 0) {
            document.getElementById('lastUpdateUser').innerText = '-';
            document.getElementById('lastUpdateTime').innerText = '-';
            return;
        }

        // Sort by timestamp descending
        const sorted = [...rawProductionData].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        const last = sorted[0];

        if (last && last.timestamp) {
            const date = new Date(last.timestamp);
            document.getElementById('lastUpdateUser').innerText = last.user || 'Unknown';
            document.getElementById('lastUpdateTime').innerText = date.toLocaleString();
        }
    }

    function renderDashboard() {
        const filtered = rawProductionData.filter(d => d.category === currentCategory);
        let planTotal = 0, actualTotal = 0;
        filtered.forEach(d => {
            if (d.type === 'Plan') planTotal += Number(d.qty);
            if (d.type === 'Actual') actualTotal += Number(d.qty);
        });
        document.getElementById('kpiTarget').innerText = planTotal.toLocaleString();
        document.getElementById('kpiActual').innerText = actualTotal.toLocaleString();
        renderTable(filtered);
        renderChart(filtered);
    }

    function consolidateForDate(dailyData) {
        const map = {};
        dailyData.forEach(item => {
            const key = item.process + '|' + item.product; 
            if (!map[key]) {
                map[key] = {
                    process: item.process,
                    product: item.product,
                    planQty: 0,
                    actualQty: 0,
                    manpower: 0,
                    batch: '',
                    planId: null,
                    actualId: null,
                    date: item.date 
                };
            }
            if (item.type === 'Plan') {
                map[key].planQty += Number(item.qty);
                map[key].planId = item.id;
            } else {
                map[key].actualQty += Number(item.qty);
                map[key].manpower = Math.max(map[key].manpower, Number(item.manpower));
                map[key].batch = item.batch || map[key].batch;
                map[key].actualId = item.id;
            }
        });
        return Object.values(map);
    }

    function renderTable(data) {
        const container = document.getElementById('tableContainer');
        const empty = document.getElementById('emptyState');
        container.innerHTML = '';

        const dataDates = data.map(d => d.date);
        const allDates = [...new Set([...dataDates, ...offDaysList])];
        allDates.sort((a,b) => new Date(b) - new Date(a));

        if (allDates.length === 0) { empty.classList.remove('hidden'); return; }
        empty.classList.add('hidden');

        let lastMonth = '';

        allDates.forEach(date => {
            const dateObj = new Date(date);
            const monthStr = dateObj.toLocaleString('default', { month: 'short', year: 'numeric' }).toUpperCase();
            
            if (monthStr !== lastMonth) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-header';
                monthDiv.innerHTML = `<span>${monthStr}</span>`;
                container.appendChild(monthDiv);
                lastMonth = monthStr;
            }

            const isOffDay = offDaysList.includes(date);
            const dailyRaw = data.filter(d => d.date === date);
            const dailyData = consolidateForDate(dailyRaw);
            
            if (dailyData.length === 0 && !isOffDay) return;

            const card = document.createElement('div');
            card.className = `glass-panel rounded-xl overflow-hidden mb-2 border-l-4 ${isOffDay ? 'border-red-500' : 'border-indigo-500'}`;
            
            const headerClass = isOffDay 
                ? 'off-day-header p-2 flex justify-between items-center' 
                : 'bg-gray-100 dark:bg-slate-800 p-2 flex justify-between items-center';
            
            const headerTextColor = isOffDay ? 'text-white' : 'text-gray-700 dark:text-gray-200';
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            
            const headerText = isOffDay 
                ? `<span class="font-bold text-sm"><i class="fas fa-calendar-times mr-2"></i>${date} (${dayName}) - OFF DAY</span>` 
                : `<span class="font-bold text-sm"><i class="fas fa-calendar-day mr-2 text-indigo-500"></i>${date} <span class="text-xs text-gray-500 ml-2 font-normal uppercase">${dayName}</span></span>`;

            const totalDailyActual = dailyData.reduce((acc, curr) => acc + curr.actualQty, 0);

            card.innerHTML = `
                <div class="${headerClass} ${headerTextColor}">
                    ${headerText}
                    ${dailyData.length > 0 ? `<span class="text-xs font-bold px-2 py-0.5 rounded bg-white/20">Total Actual: ${totalDailyActual}</span>` : ''}
                </div>
            `;

            if (dailyData.length > 0) {
                const table = document.createElement('table');
                table.className = `w-full text-sm ${isOffDay ? 'off-day-body' : ''}`;
                table.innerHTML = `
                    <thead class="bg-gray-50 dark:bg-slate-900/50 text-xs uppercase text-gray-500 border-b dark:border-slate-700">
                        <tr>
                            <th class="p-2 text-left">Process</th>
                            <th class="p-2 text-left">Product</th>
                            <th class="p-2 text-right">Plan Quantity</th>
                            <th class="p-2 text-right">Actual Quantity</th>
                            <th class="p-2 text-center">Efficiency</th>
                            <th class="p-2 text-center">Batch No</th>
                            <th class="p-2 text-center">Manpower</th>
                            ${(currentUser && (currentUser.role === 'Manager' || currentUser.role === 'Admin')) ? '<th class="p-2 text-center">Action</th>' : ''}
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-slate-700"></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                dailyData.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    let eff = 0;
                    let effColor = 'text-gray-400';
                    if (row.planQty > 0 && row.actualQty > 0) {
                        eff = Math.round((row.actualQty / row.planQty) * 100);
                        if (eff >= 80) effColor = 'text-green-600 font-bold'; 
                        else effColor = 'text-red-600 font-bold'; 
                    }

                    tr.innerHTML = `
                        <td class="p-2"><span class="px-2 py-0.5 bg-indigo-50 text-indigo-700 rounded text-xs font-bold">${row.process}</span></td>
                        <td class="p-2 font-medium">${row.product}</td>
                        <td class="p-2 text-right font-mono font-bold text-blue-600">${row.planQty}</td>
                        <td class="p-2 text-right font-mono font-bold text-green-600">${row.actualQty}</td>
                        <td class="p-2 text-center ${effColor}">${eff}%</td>
                        <td class="p-2 text-center font-mono text-xs text-gray-500">${row.batch || '-'}</td>
                        <td class="p-2 text-center">${row.manpower}</td>
                        ${(currentUser && (currentUser.role === 'Manager' || currentUser.role === 'Admin')) ? `
                        <td class="p-2 text-center">
                            <button onclick="openEditModalFromRow('${row.date}', '${row.process}', '${row.product}', '${row.planId}', '${row.actualId}', ${row.planQty}, ${row.actualQty}, '${row.batch}')" class="text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button>
                        </td>` : ''}
                    `;
                    tbody.appendChild(tr);
                });
                card.appendChild(table);
            } else {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = "p-2 text-center text-xs text-gray-500 italic bg-red-50 dark:bg-red-900/20";
                emptyMsg.innerText = "No Production Data";
                card.appendChild(emptyMsg);
            }
            container.appendChild(card);
        });
    }

    function renderChart(data) {
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        if (weeklyChart) weeklyChart.destroy();
        const processes = [...new Set(data.map(d => d.process))];
        const planData = processes.map(p => data.filter(d => d.process === p && d.type === 'Plan').reduce((a,b)=>a+Number(b.qty),0));
        const actualData = processes.map(p => data.filter(d => d.process === p && d.type === 'Actual').reduce((a,b)=>a+Number(b.qty),0));

        weeklyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: processes,
                datasets: [
                    { label: 'Plan', data: planData, backgroundColor: '#3b82f6' },
                    { label: 'Actual', data: actualData, backgroundColor: '#10b981' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
        });
    }

    // Input & Edit Logic
    function openInputModal() { 
        document.getElementById('inputDate').valueAsDate = new Date(); 
        document.getElementById('inputModal').classList.remove('hidden');
        
        // --- ROLE BASED TAB LOGIC ---
        const tabPlanBtn = document.getElementById('tabPlan');
        const tabActualBtn = document.getElementById('tabActual');
        
        // Reset visibility
        tabPlanBtn.style.display = 'block';
        tabActualBtn.style.display = 'block';

        if (currentUser.role === 'Planner') {
            tabActualBtn.style.display = 'none'; // Hide Actual
            switchInputTab('Plan');
        } else if (currentUser.role === 'Operator') {
            tabPlanBtn.style.display = 'none'; // Hide Plan
            switchInputTab('Actual');
        } else {
            // Manager/Admin see both, default to Plan
            switchInputTab('Plan');
        }
    }

    function closeInputModal() { document.getElementById('inputModal').classList.add('hidden'); }
    
    function switchInputTab(type) {
        document.getElementById('inputType').value = type;
        const p = document.getElementById('tabPlan');
        const a = document.getElementById('tabActual');
        const f = document.getElementById('actualFields');
        const m = document.getElementById('manpowerFieldContainer'); 

        if (type === 'Plan') { 
            // Activate Plan Tab
            p.classList.add('bg-indigo-50','text-indigo-700','border-b-2','border-indigo-600'); 
            p.classList.remove('text-gray-500'); 
            a.classList.remove('bg-emerald-50','text-emerald-700','border-b-2','border-emerald-600');
            a.classList.add('text-gray-500'); 
            f.classList.add('hidden');
            m.classList.add('hidden');
        } else { 
            // Activate Actual Tab
            a.classList.add('bg-emerald-50','text-emerald-700','border-b-2','border-emerald-600'); 
            a.classList.remove('text-gray-500'); 
            p.classList.remove('bg-indigo-50','text-indigo-700','border-b-2','border-indigo-600'); 
            p.classList.add('text-gray-500'); 
            f.classList.remove('hidden');
            m.classList.remove('hidden');
        }
    }

    function submitData() {
        const type = document.getElementById('inputType').value;
        const date = document.getElementById('inputDate').value;
        const category = document.getElementById('inputCategory').value;
        const process = document.getElementById('inputProcess').value;
        const product = document.getElementById('inputProduct').value;
        const qty = document.getElementById('inputQty').value;
        
        if (!date || !qty || !product) {
            alert('Sila isi semua ruangan yang wajib (Tarikh, Produk, Kuantiti).'); 
            return;
        }

        const data = {
            date: date,
            type: type,
            category: category,
            process: process,
            product: product,
            qty: Number(qty),
            user: currentUser.username,
            timestamp: new Date().toISOString()
        };

        if (type === 'Actual') {
            data.batch = document.getElementById('inputBatch').value;
            data.manpower = Number(document.getElementById('inputManpower').value);
        } else {
            data.batch = 'N/A';
            data.manpower = 0;
        }

        runGoogleScript('submitData', JSON.stringify(data), (res) => {
            if (res.success) {
                alert(`Data ${type} berjaya dihantar.`);
                closeInputModal();
                fetchData();
            } else {
                alert('Gagal menghantar data: ' + res.error);
            }
        });
    }

    function openEditModalFromRow(date, process, product, planId, actualId, planQty, actualQty, batch) {
        document.getElementById('editDateDisplay').value = date + ' / ' + process;
        document.getElementById('editProduct').value = product;
        document.getElementById('editPlanQty').value = planQty;
        document.getElementById('editActualQty').value = actualQty;
        document.getElementById('editBatch').value = batch;

        document.getElementById('editPlanId').value = planId;
        document.getElementById('editActualId').value = actualId;

        // Tunjukkan atau sembunyikan medan Plan/Actual berdasarkan ID yang ada
        const planInput = document.getElementById('editPlanQty').parentNode;
        const actualInput = document.getElementById('editActualQty').parentNode;
        const batchInput = document.getElementById('editBatch').parentNode;

        if (planId && planId !== 'null') {
            planInput.classList.remove('hidden');
        } else {
            planInput.classList.add('hidden');
        }
        
        if (actualId && actualId !== 'null') {
            actualInput.classList.remove('hidden');
            batchInput.classList.remove('hidden');
        } else {
            actualInput.classList.add('hidden');
            batchInput.classList.add('hidden');
        }
        
        document.getElementById('editModal').classList.remove('hidden');
    }
    
    function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

    function saveEdit() {
        const planId = document.getElementById('editPlanId').value;
        const actualId = document.getElementById('editActualId').value;
        const newPlanQty = document.getElementById('editPlanQty').value;
        const newActualQty = document.getElementById('editActualQty').value;
        const newBatch = document.getElementById('editBatch').value;
        
        const updates = [];

        // Update Plan
        if (planId && planId !== 'null') {
            updates.push({
                id: planId,
                type: 'Plan',
                qty: Number(newPlanQty),
                user: currentUser.username
            });
        }
        
        // Update Actual
        if (actualId && actualId !== 'null') {
             updates.push({
                id: actualId,
                type: 'Actual',
                qty: Number(newActualQty),
                batch: newBatch,
                user: currentUser.username
            });
        }

        if (updates.length > 0) {
            runGoogleScript('updateData', JSON.stringify(updates), (res) => {
                if (res.success) {
                    alert('Data berjaya dikemaskini.');
                    closeEditModal();
                    fetchData();
                } else {
                    alert('Gagal mengemaskini data: ' + res.error);
                }
            });
        }
    }


    // Authentication Logic
    function openLoginModal() { document.getElementById('loginModal').classList.remove('hidden'); }
    function closeLoginModal() { 
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    }

    function updateUIForUser() {
        if (currentUser) {
            document.getElementById('userProfileSection').innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900/50 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-300">
                        <i class="fas fa-user text-xl"></i>
                    </div>
                    <div>
                        <p class="font-bold">${currentUser.username}</p>
                        <p class="text-xs text-indigo-600 dark:text-indigo-400 font-semibold">${currentUser.role}</p>
                    </div>
                </div>
                <button onclick="performLogout()" class="text-sm text-red-500 hover:text-red-700"><i class="fas fa-sign-out-alt"></i></button>
            `;
            document.getElementById('inputDataBtn').classList.remove('hidden');

            const isManagerOrAdmin = currentUser.role === 'Manager' || currentUser.role === 'Admin';
            document.getElementById('managerControls').classList.toggle('hidden', !isManagerOrAdmin);
            document.getElementById('adminControls').classList.toggle('hidden', currentUser.role !== 'Admin');

        } else {
            document.getElementById('userProfileSection').innerHTML = `<button onclick="openLoginModal()" class="w-full px-3 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30">Login System</button>`;
            document.getElementById('inputDataBtn').classList.add('hidden');
            document.getElementById('managerControls').classList.add('hidden');
            document.getElementById('adminControls').classList.add('hidden');
        }
        renderDashboard(); // Re-render table to show/hide edit buttons
    }

    function performLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        if (typeof google !== 'undefined' && google.script) {
            google.script.run.withSuccessHandler(user => {
                if (user && user.username) {
                    currentUser = user;
                    localStorage.setItem('mfg_user', JSON.stringify(currentUser));
                    closeLoginModal();
                    updateUIForUser();
                    alert(`Selamat datang, ${currentUser.username} (${currentUser.role})!`);
                } else {
                    alert('Username atau password salah.');
                }
            }).authenticateUser(username, password);
        } else {
            // Local fallback login
            const user = usersList.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                localStorage.setItem('mfg_user', JSON.stringify(currentUser));
                closeLoginModal();
                updateUIForUser();
                alert(`Selamat datang, ${currentUser.username} (${currentUser.role})!`);
            } else {
                alert('Username atau password salah.');
            }
        }
    }

    function performLogout() {
        currentUser = null;
        localStorage.removeItem('mfg_user');
        updateUIForUser();
        alert('Anda telah log keluar.');
    }


    // Off Day Management
    function openOffDayModal() {
        if (!currentUser || (currentUser.role !== 'Manager' && currentUser.role !== 'Admin')) return;
        renderOffDayList();
        document.getElementById('offDayModal').classList.remove('hidden');
    }
    
    function closeOffDayModal() { document.getElementById('offDayModal').classList.add('hidden'); }

    function renderOffDayList() {
        const list = document.getElementById('offDayList');
        list.innerHTML = '';
        offDaysList.sort();
        offDaysList.forEach((day, index) => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center bg-white dark:bg-slate-700 p-2 rounded';
            li.innerHTML = `
                <span>${day}</span>
                <button onclick="removeOffDay(${index})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
            `;
            list.appendChild(li);
        });
    }

    function addOffDay() {
        const date = document.getElementById('offDayPicker').value;
        if (date && !offDaysList.includes(date)) {
            offDaysList.push(date);
            renderOffDayList();
        } else if (offDaysList.includes(date)) {
            alert('Tarikh ini sudah ada dalam senarai cuti.');
        }
    }

    function removeOffDay(index) {
        offDaysList.splice(index, 1);
        renderOffDayList();
    }

    function saveOffDays() {
        runGoogleScript('saveOffDays', JSON.stringify(offDaysList), (res) => {
            if (res.success) {
                alert('Tarikh cuti telah disimpan.');
                closeOffDayModal();
                renderDashboard();
            } else {
                alert('Gagal menyimpan cuti: ' + res.error);
            }
        });
    }

    // User Management (Admin Only)
    function openUserModal() {
        if (!currentUser || currentUser.role !== 'Admin') return;
        fetchUsers();
    }

    function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); }

    function fetchUsers() {
        if (typeof google !== 'undefined' && google.script) {
            google.script.run.withSuccessHandler(u => {
                usersList = JSON.parse(u);
                renderUserList();
                document.getElementById('userModal').classList.remove('hidden');
            }).getUsers();
        } else {
             // Local Fallback
            renderUserList();
            document.getElementById('userModal').classList.remove('hidden');
        }
    }

    function renderUserList() {
        const listBody = document.getElementById('userListBody');
        listBody.innerHTML = '';
        usersList.forEach(user => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 dark:hover:bg-slate-700/50';
            tr.innerHTML = `
                <td class="p-2 font-medium">${user.username}</td>
                <td class="p-2 text-indigo-600 font-semibold">${user.role}</td>
                <td class="p-2 text-center">
                    ${user.username !== currentUser.username ? `
                        <button onclick="deleteUser('${user.username}')" class="text-red-500 hover:text-red-700 disabled:opacity-50" ${user.role === 'Admin' ? 'disabled' : ''}>
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    ` : '<span class="text-gray-400 text-xs">Current User</span>'}
                </td>
            `;
            listBody.appendChild(tr);
        });
    }

    function addNewUser() {
        const username = document.getElementById('newUsername').value;
        const password = document.getElementById('newPassword').value;
        const role = document.getElementById('newRole').value;

        if (!username || !password) {
            alert('Username dan Password diperlukan.');
            return;
        }

        const newUser = { username, password, role };

        runGoogleScript('addUser', JSON.stringify(newUser), (res) => {
            if (res.success) {
                alert(`Pengguna ${username} (${role}) telah ditambah.`);
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
                fetchUsers(); // Refresh list
            } else {
                alert('Gagal menambah pengguna: ' + res.error);
            }
        });
    }

    function deleteUser(username) {
        if (confirm(`Adakah anda pasti mahu memadam pengguna ${username}?`)) {
            runGoogleScript('deleteUser', JSON.stringify({ username: username }), (res) => {
                if (res.success) {
                    alert(`Pengguna ${username} telah dipadam.`);
                    fetchUsers(); // Refresh list
                } else {
                    alert('Gagal memadam pengguna: ' + res.error);
                }
            });
        }
    }

    function alert(message) {
        // Simple custom alert for a better user experience
        const existingAlert = document.getElementById('customAlert');
        if (existingAlert) existingAlert.remove();

        const alertDiv = document.createElement('div');
        alertDiv.id = 'customAlert';
        alertDiv.className = 'fixed top-4 right-4 bg-indigo-600 text-white p-4 rounded-xl shadow-xl z-[9999] transition-all duration-300 transform translate-x-full opacity-0';
        alertDiv.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-info-circle"></i> <span>${message}</span></div>`;
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.classList.remove('translate-x-full', 'opacity-0');
            alertDiv.classList.add('translate-x-0', 'opacity-100');
        }, 10);

        setTimeout(() => {
            alertDiv.classList.remove('translate-x-0', 'opacity-100');
            alertDiv.classList.add('translate-x-full', 'opacity-0');
        }, 3000);

        setTimeout(() => {
            alertDiv.remove();
        }, 3500);
    }

    function confirm(message) {
        // Implement a custom confirm modal instead of window.confirm
        return window.prompt(message + " (Taip 'YA' untuk teruskan)") === 'YA';
    }


  </script>
</body>
</html>
